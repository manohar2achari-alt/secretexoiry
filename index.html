<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App Registration Secret Alerts</title>

<style>
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
        background: #fdfdfd;
        color: #111;
    }

    /* Smooth fade animations */
    .fade {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 1s ease forwards;
    }

    @keyframes fadeIn {
        to { opacity: 1; transform: translateY(0); }
    }

    /* Hero section */
    .hero {
        padding: 120px 20px;
        text-align: center;
        background: linear-gradient(180deg, #fafafa, #ffffff);
    }
    .hero h1 {
        font-size: 54px;
        font-weight: 700;
        margin-bottom: 20px;
        letter-spacing: -1px;
    }
    .hero p {
        font-size: 22px;
        color: #555;
        max-width: 700px;
        margin: 0 auto;
    }

    /* Sections */
    h2 {
        font-size: 38px;
        text-align: center;
        margin-top: 80px;
        margin-bottom: 20px;
        color: #111;
    }

    /* Card styling */
    .card {
        max-width: 950px;
        margin: 25px auto;
        padding: 40px;
        border-radius: 28px;
        background: white;
        box-shadow: 0 12px 35px rgba(0,0,0,0.08);
    }

    .step-title {
        font-size: 26px;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .step-text {
        font-size: 18px;
        color: #444;
        line-height: 1.6;
    }

    /* Screenshot placeholder */
    .shot {
        width: 100%;
        height: 260px;
        background: #ececec;
        border-radius: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #888;
        font-size: 18px;
        margin-top: 20px;
        font-style: italic;
    }

    /* Code */
    pre {
        background: #f5f5f7;
        padding: 22px;
        border-radius: 16px;
        overflow-x: auto;
        font-size: 15px;
        line-height: 1.5;
        margin-top: 20px;
    }

    footer {
        text-align: center;
        padding: 40px;
        color: #777;
        margin-top: 80px;
        font-size: 14px;
    }
</style>
</head>

<body>

<!-- HERO -->
<section class="hero fade">
    <h1>App Registration Secret Alerts</h1>
    <p>A clean, reliable Azure Automation runbook that sends early email alerts (60, 30, 7 days before expiry) for all App Registration secrets in your tenant.</p>
</section>

<!-- SETUP -->
<h2 class="fade">Step-by-Step Setup Guide</h2>

<!-- STEP 1 -->
<div class="card fade">
    <div class="step-title">1. Create an Azure Automation Account</div>
    <div class="step-text">
        • Navigate to Azure Portal → Automation Accounts → Create<br>
        • Enable System Assigned Managed Identity<br>
        • Use the same region as your apps for faster Graph access
    </div>

    <div class="shot">Screenshot Placeholder (Automation Account)</div>
</div>

<!-- STEP 2 -->
<div class="card fade">
    <div class="step-title">2. Locate the Managed Identity Service Principal</div>
    <div class="step-text">
        Every Automation Account creates a Managed Identity. We must assign Graph <strong>application</strong> permissions to this identity (not delegated permissions).<br><br>

        First, sign in with a privileged account:
    </div>

<pre>
Install-Module Microsoft.Graph -Scope CurrentUser -Force
Connect-MgGraph -Scopes "Application.ReadWrite.All","AppRoleAssignment.ReadWrite.All"

$mi = Get-MgServicePrincipal -Filter "displayName eq 'YOUR-AUTOMATION-ACCOUNT-NAME'"
$mi
</pre>

    <div class="shot">Screenshot Placeholder (Managed Identity SP)</div>
</div>

<!-- STEP 3 -->
<div class="card fade">
    <div class="step-title">3. Assign Microsoft Graph App Permissions (AppRole Assignments)</div>
    <div class="step-text">
        Managed Identity needs:<br>
        • Application.Read.All<br>
        • Directory.Read.All<br>
        • Mail.Send (App-only)<br><br>

        These must be assigned via Graph (not the portal).
    </div>

<pre>
$graph = Get-MgServicePrincipal -Filter "displayName eq 'Microsoft Graph'"

# Mail.Send (Application permission)
$mailSend = $graph.AppRoles | 
    Where-Object { $_.Value -eq "Mail.Send" -and $_.AllowedMemberTypes -contains "Application" }

# Assign permission
New-MgServicePrincipalAppRoleAssignedTo `
 -ServicePrincipalId $mi.Id `
 -PrincipalId $mi.Id `
 -ResourceId $graph.Id `
 -AppRoleId $mailSend.Id
</pre>

    <div class="shot">Screenshot Placeholder (Graph Permission Assignment)</div>
</div>

<!-- STEP 4 -->
<div class="card fade">
    <div class="step-title">4. Sending Email Using Managed Identity (Shared Mailbox)</div>
    <div class="step-text">
        Your Managed Identity will send email <strong>as your shared mailbox</strong> using <code>Send-MgUserMail</code>.<br><br>
        In the shared mailbox, assign:<br>
        • “Send As” → to the Managed Identity’s service principal<br><br>
        Example:
    </div>

<pre>
Send-MgUserMail -UserId "alerts-mailbox@domain.com" -Body @{
  ContentType = "HTML"
  Content = "Secret expiring soon..."
} -Subject "App Secret Expiry Notice" `
 -ToRecipients @(@{EmailAddress = @{Address="iam-team@domain.com"}})
</pre>

    <div class="shot">Screenshot Placeholder (Shared Mailbox Permissions)</div>
</div>

<!-- STEP 5 -->
<div class="card fade">
    <div class="step-title">5. The Final Runbook Script</div>
    <div class="step-text">
        This runbook checks all App Registration secrets, finds ones expiring in 60, 30, or 7 days, and emails your IAM DL.
    </div>

<pre>
Connect-AzAccount -Identity
Connect-MgGraph -Identity

$notifyDays = @(60, 30, 7)
$today = Get-Date

$apps = Get-MgApplication -All

foreach ($app in $apps) {
    foreach ($cred in $app.PasswordCredentials) {

        $expiry = Get-Date $cred.EndDateTime
        $daysLeft = ($expiry - $today).Days

        if ($notifyDays -contains $daysLeft) {
            Send-MgUserMail -UserId "alerts-mailbox@domain.com" `
                -Body @{
                    ContentType = "HTML"
                    Content = "<b>$($app.DisplayName)</b> secret expires on <b>$expiry</b>."
                } -Subject "⚠ Secret expiring in $daysLeft days" `
                -ToRecipients @(@{EmailAddress = @{Address="iam-team@domain.com"}})
        }
    }
}
</pre>

    <div class="shot">Screenshot Placeholder (Runbook Verify)</div>
</div>

<!-- STEP 6 -->
<div class="card fade">
    <div class="step-title">6. Schedule the Runbook</div>
    <div class="step-text">
        • Go to your runbook → Schedules → Add Schedule<br>
        • Run it **daily**<br>
        • Test manually for the first run to verify email delivery
    </div>

    <div class="shot">Screenshot Placeholder (Schedule Setup)</div>
</div>

<footer>
    © 2025 · App Registration Secret Alerts · Designed for IAM Teams
</footer>

</body>
</html>
