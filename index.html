<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>App Registration Secret Alerts</title>

<style>
    /* Apple-style fonts */
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        background: #ffffff;
        color: #111;
    }

    /* Smooth fade-in animation */
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 0.8s ease forwards;
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Hero Section */
    .hero {
        text-align: center;
        padding: 100px 20px;
        background: linear-gradient(180deg, #fafafa, #ffffff);
    }

    .hero h1 {
        font-size: 48px;
        font-weight: 600;
        margin-bottom: 20px;
        letter-spacing: -1px;
    }

    .hero p {
        font-size: 22px;
        max-width: 600px;
        margin: 0 auto;
        color: #555;
        line-height: 1.5;
    }

    /* Section Headers */
    h2 {
        font-size: 36px;
        margin-top: 80px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 600;
        letter-spacing: -0.5px;
    }

    /* Card Layout */
    .card {
        max-width: 900px;
        margin: 20px auto;
        padding: 30px;
        background: #fefefe;
        border-radius: 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.05);
    }

    .step-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .step-text {
        color: #444;
        line-height: 1.6;
        font-size: 18px;
    }

    /* Code Block */
    pre {
        background: #f5f5f7;
        padding: 20px;
        border-radius: 16px;
        overflow-x: auto;
        font-size: 14px;
        line-height: 1.5;
        margin-top: 20px;
    }

    /* Screenshot Placeholder */
    .screenshot {
        width: 100%;
        height: 260px;
        background: #eaeaea;
        border-radius: 18px;
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #888;
        font-size: 18px;
        font-style: italic;
    }

    /* Footer */
    footer {
        text-align: center;
        padding: 40px;
        color: #777;
        margin-top: 60px;
        font-size: 14px;
    }

</style>
</head>

<body>

<div class="hero fade-in">
    <h1>App Registration Secret Alerts</h1>
    <p>
        A lightweight and reliable Azure Automation runbook that sends early warning
        email alerts when any App Registration secret is 60, 30, or 7 days from expiration.
    </p>
</div>

<h2 class="fade-in">Quick Setup Guide</h2>

<!-- Step 1 -->
<div class="card fade-in">
    <div class="step-title">1. Create an Azure Automation Account</div>
    <div class="step-text">
        - Go to Azure Portal → “Automation Accounts” → New Account<br>
        - Choose same region as your workloads<br>
        - Enable System Assigned Managed Identity
    </div>

    <div class="screenshot">Screenshot Placeholder (Automation Account)</div>
</div>

<!-- Step 2 -->
<div class="card fade-in">
    <div class="step-title">2. Assign Required Graph API Permissions</div>
    <div class="step-text">
        Give the automation account’s Managed Identity the following permissions:<br><br>

        <b>Microsoft Graph → Application.Read.All</b><br>
        <b>Microsoft Graph → Directory.Read.All</b><br>
        <b>Microsoft Graph → Mail.Send</b><br><br>

        Assign them under:<br>
        <i>Azure → Subscriptions → IAM → Add Role Assignment → Privileged Role Administrator / Directory Reader</i>
    </div>

    <div class="screenshot">Screenshot Placeholder (Permissions)</div>
</div>

<!-- Step 3 -->
<div class="card fade-in">
    <div class="step-title">3. Create a Mailbox to Send Alerts</div>
    <div class="step-text">
        - Create a dedicated mailbox (example: automation-alerts@domain.com)<br>
        - Add this mailbox as a member of your IAM Distribution List<br>
        - Store credentials securely in the Automation Account under “Variables” or “Credentials”
    </div>

    <div class="screenshot">Screenshot Placeholder (Mailbox Setup)</div>
</div>

<!-- Step 4 -->
<div class="card fade-in">
    <div class="step-title">4. Import the Runbook Script</div>

    <div class="step-text">Use the following script inside your PowerShell runbook:</div>

    <pre>
$connectionName = "AzureRunAsConnection"
Connect-AzAccount -Identity

Write-Output "Fetching App Registrations..."

$apps = az ad app list --query "[].{displayName:displayName, objectId:id}" | ConvertFrom-Json

$today = Get-Date
$notifyDays = @(60, 30, 7)

foreach ($app in $apps) {
    $secrets = az ad app credential list --id $app.objectId | ConvertFrom-Json
    foreach ($secret in $secrets) {
        $expiry = Get-Date $secret.endDateTime
        $daysLeft = ($expiry - $today).Days

        if ($notifyDays -contains $daysLeft) {
            Send-MailMessage `
                -To "iam-alerts@domain.com" `
                -From "automation-alerts@domain.com" `
                -Subject "⚠ Secret expiring in $daysLeft days: $($app.displayName)" `
                -Body "Secret for $($app.displayName) expires on $expiry." `
                -SmtpServer "smtp.office365.com" `
                -Port 587 `
                -UseSsl `
                -Credential (Get-AutomationPSCredential -Name "AlertMailboxCreds")
        }
    }
}
    </pre>

    <div class="screenshot">Screenshot Placeholder (Runbook Import)</div>
</div>

<!-- Step 5 -->
<div class="card fade-in">
    <div class="step-title">5. Schedule the Runbook</div>
    <div class="step-text">
        - Create a schedule that runs <b>once every day</b><br>
        - Link the schedule to this runbook<br>
        - Test run it manually to verify alert emails
    </div>

    <div class="screenshot">Screenshot Placeholder (Scheduling)</div>
</div>

<footer>
    © 2025 App Registration Secret Alerts · Built for IAM Teams
</footer>

</body>
</html>
